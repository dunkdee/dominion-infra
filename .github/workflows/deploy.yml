name: Deploy
on:
  push:
    branches: [ main ]
jobs:
  ship:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Write SSH key
        run: |
          echo "${SSH_KEY}" > key
          chmod 600 key

      - name: Rsync infra to VM
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          rsync -az -e "ssh -i key -p \${SSH_PORT:-22} -o StrictHostKeyChecking=no" \
            infra/ "\${SSH_USER}@\${SSH_HOST}:/opt/dominion/infra/"

      - name: Compose up
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i key -p \${SSH_PORT:-22} -o StrictHostKeyChecking=no \
            "\${SSH_USER}@\${SSH_HOST}" \
            "sudo -n docker compose -f /opt/dominion/infra/docker-compose.yml up -d"
